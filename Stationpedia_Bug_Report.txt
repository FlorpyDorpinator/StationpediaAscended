================================================================================
STATIONPEDIA UI BUGS - REPORT & FIXES
================================================================================

This document describes two bugs in the Stationpedia UI and their fixes.

================================================================================
BUG #1: SCROLLBAR HANDLE VISIBILITY/POSITION
================================================================================

SUMMARY:
--------
The scrollbar handle in Stationpedia becomes invisible or incorrectly positioned
when navigating to non-home pages. The scrollbar track is visible but the
draggable handle appears to be missing or offset from its correct position.

SYMPTOMS:
---------
- Scrollbar handle not visible on detail pages (e.g., item pages, device pages)
- Handle appears offset (too high or too low) from where it should be
- Scrolling still works via mouse wheel, but visual feedback is broken
- The handle IS functional - dragging the "empty" area where it should be works

ROOT CAUSE:
-----------
The scrollbar Handle's RectTransform.localPosition is being corrupted during
page transitions. The Handle uses anchor-based positioning with:
  - sizeDelta = (0, 0)
  - Anchors stretch to define position within the Sliding Area parent

For anchor-based UI elements with sizeDelta=(0,0), localPosition MUST be (0,0,0).
Any non-zero localPosition value offsets the element from its anchor-defined
position, causing it to render outside the visible scrollbar track area.

OBSERVED CORRUPTION VALUES:
---------------------------
- localPosition.y = NaN (causes complete invisibility)
- localPosition.y = -250 to -251 (handle renders ~250px too low)
- localPosition.y = +445 (handle renders ~445px too high)

The corruption appears to occur during/after the FixTheScrollValue() async
method runs in Stationpedia.Render().

AFFECTED CODE PATH:
-------------------
Stationpedia.cs:
  SetPage() [line ~430]
    -> Sets ScrollBarUniversal.value = 1f for new pages
    -> Calls Render()
  
  Render() [line ~696]
    -> Calls UniversalPageRef.ChangeDisplay(page)
    -> Calls LayoutRebuilder.ForceRebuildLayoutImmediate(ContentRectTransform)
    -> Calls FixTheScrollValue(page).Forget()  <-- ASYNC, runs after layout

The FixTheScrollValue() async method appears to be where the corruption occurs,
likely due to timing issues between the layout rebuild and anchor recalculation.

RECOMMENDED FIX:
----------------
After any scroll-related operations complete, ensure the Handle's localPosition
is reset to Vector3.zero. This should be done:

1. At the end of FixTheScrollValue() async method
2. Or as a post-processing step after layout rebuilds

Example fix code:

    // After layout operations complete:
    if (ScrollBarUniversal != null && ScrollBarUniversal.handleRect != null)
    {
        var handleRect = ScrollBarUniversal.handleRect;
        
        // The handle uses anchor-based positioning - localPosition must be zero
        if (handleRect.localPosition != Vector3.zero)
        {
            handleRect.localPosition = Vector3.zero;
            handleRect.anchoredPosition = Vector2.zero;
        }
    }

ALTERNATIVE FIX:
----------------
The fix may need to be applied multiple times over several frames if there's
async code that continues to corrupt the position. A coroutine that applies
the fix for 3-5 frames after page change ensures it "sticks":

    private IEnumerator FixScrollbarHandlePosition()
    {
        yield return new WaitForEndOfFrame();
        
        for (int i = 0; i < 5; i++)
        {
            if (ScrollBarUniversal?.handleRect != null)
            {
                var handle = ScrollBarUniversal.handleRect;
                if (handle.localPosition != Vector3.zero)
                {
                    handle.localPosition = Vector3.zero;
                    handle.anchoredPosition = Vector2.zero;
                }
            }
            yield return null;
        }
    }

TECHNICAL DETAILS:
------------------
The Scrollbar component manages handle positioning via anchors:
  - anchorMin.y = value * (1 - size)  
  - anchorMax.y = anchorMin.y + size
  
When these anchors are set correctly but localPosition is non-zero, the visual
position doesn't match the logical position, causing the mismatch.


================================================================================
BUG #2: STATIONPEDIA WINDOW NOT DRAGGABLE IN MAIN MENU
================================================================================

SUMMARY:
--------
The Stationpedia window cannot be dragged when opened from the main menu
(before starting/loading a game). Attempting to drag the window does nothing
or may cause errors.

SYMPTOMS:
---------
- Window is stuck in place when opened from main menu
- Dragging works normally when in-game
- No visual feedback when attempting to drag in main menu

ROOT CAUSE:
-----------
The Stationpedia.OnDrag() method calls ClampToScreen(), which internally
accesses InventoryManager.ParentHuman. In the main menu, there is no player
character, so ParentHuman is null, causing the drag operation to fail silently
or throw a NullReferenceException.

AFFECTED CODE PATH:
-------------------
Stationpedia.cs:
  OnDrag(PointerEventData eventData)
    -> Calls ClampToScreen()
      -> Accesses InventoryManager.ParentHuman  <-- NULL in main menu!

RECOMMENDED FIX:
----------------
Option 1: Add a null check before calling ClampToScreen():

    public override void OnDrag(PointerEventData eventData)
    {
        base.OnDrag(eventData);
        
        // Only clamp to screen if we're in-game with a valid player
        if (InventoryManager.ParentHuman != null)
        {
            ClampToScreen();
        }
    }

Option 2: Make ClampToScreen() handle the null case gracefully:

    protected void ClampToScreen()
    {
        // Early exit if not in-game
        if (InventoryManager.ParentHuman == null)
            return;
            
        // ... rest of existing code ...
    }

Option 3: Replace OnDrag with a simpler implementation that doesn't need
ClampToScreen when in main menu:

    public override void OnDrag(PointerEventData eventData)
    {
        // Simple drag - just move to mouse position with offset
        RectTransform.position = eventData.position - _dragOffset;
        
        // Only clamp if in-game
        if (InventoryManager.ParentHuman != null)
        {
            ClampToScreen();
        }
    }


================================================================================
WORKAROUNDS IMPLEMENTED IN STATIONPEDIAPLUS MOD
================================================================================

The StationpediaPlus mod fixes both bugs:

BUG #1 FIX (Scrollbar):
-----------------------
1. Sets ScrollRect.verticalScrollbarVisibility to Permanent (not AutoHide)
2. Monitors for page changes via Stationpedia.OnPageChanged event
3. Runs a coroutine that waits for layout to complete (~4 frames)
4. Resets handleRect.localPosition and anchoredPosition to zero
5. Repeats the fix for 5 frames to combat any re-corruption

BUG #2 FIX (Dragging):
----------------------
1. Patches OnBeginDrag to capture the mouse offset from window position
2. Patches OnDrag to use simple position assignment without ClampToScreen
3. Both patches return false to skip the original buggy implementations

Both fixes completely resolve the visual/functional bugs.

================================================================================
Report prepared: December 28, 2025
Fixed by: FlorpyDorp
Implemented in: StationpediaPlus mod
================================================================================
